<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Go big.Int add one performance curiosity - vpereira01</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Go big.Int add one performance curiosity"><meta property="og:description" content="Trying to solve a coding exercise I noticed that doing z.Add(z, one) is kind of slow so I implemented my own increment method :)
Practicing Go by solving the CodeWars exercise &ldquo;Fabergé Easter Eggs crush test&rdquo;, I was able to find a simple, and slow solution, by performing many many additions. This simple solution was enough to meet the test requirements but something bugged me from my CPU profilings, z.Add(z, one) was taking cumulative more than one second."><meta property="og:type" content="article"><meta property="og:url" content="https://vpereira01.com/posts/go-bigint-perf/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-13T15:15:11+01:00"><meta property="article:modified_time" content="2022-05-13T15:15:11+01:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go big.Int add one performance curiosity"><meta name=twitter:description content="Trying to solve a coding exercise I noticed that doing z.Add(z, one) is kind of slow so I implemented my own increment method :)
Practicing Go by solving the CodeWars exercise &ldquo;Fabergé Easter Eggs crush test&rdquo;, I was able to find a simple, and slow solution, by performing many many additions. This simple solution was enough to meet the test requirements but something bugged me from my CPU profilings, z.Add(z, one) was taking cumulative more than one second."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://vpereira01.com/posts/go-bigint-perf/><link rel=prev href=https://vpereira01.com/posts/hey/><link rel=next href=https://vpereira01.com/posts/zoom-ipv6-router-bug/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Go big.Int add one performance curiosity","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/vpereira01.com\/posts\/go-bigint-perf\/"},"genre":"posts","keywords":"go, golang","wordcount":807,"url":"https:\/\/vpereira01.com\/posts\/go-bigint-perf\/","datePublished":"2022-05-13T15:15:11+01:00","dateModified":"2022-05-13T15:15:11+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"vpereira01"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=vpereira01>My cool site</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=vpereira01>My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Go big.Int add one performance curiosity</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/about title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>vpereira01</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-05-13>2022-05-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;807 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#investigation>Investigation</a></li><li><a href=#hypothesis-01-a-lengthier-bigint>Hypothesis 01, a lengthier big.Int</a></li><li><a href=#hypothesis-02-avoid-bigintadd>Hypothesis 02, avoid big.Int.Add()</a></li><li><a href=#solution-and-benchmark>Solution and benchmark</a></li><li><a href=#extra-benchmarks>Extra benchmarks</a></li></ul></nav></div></div><div class=content id=content><p>Trying to solve a coding exercise I noticed that doing <code>z.Add(z, one)</code> is kind of slow so I implemented my own increment method :)</p><p>Practicing Go by solving the CodeWars <a href=https://www.codewars.com//kata/54cb771c9b30e8b5250011d4 target=_blank rel="noopener noreffer">exercise</a> &ldquo;Fabergé Easter Eggs crush test&rdquo;, I was able to find a simple, and slow solution, by performing many many additions. This simple solution was enough to meet the test requirements but something bugged me from my CPU profilings, <code>z.Add(z, one)</code> was taking cumulative more than one second. In comparison, adding two big numbers was taking cumulative more than five seconds.</p><p>For context, the results can have more than 3000 digits so a library which supports those kind of numbers is required. Go standard library provides &ldquo;math/big&rdquo; which is an arbitrary-precision arithmetic package and thus it&rsquo;s the default one and the one I could use in the exercise.</p><h2 id=investigation>Investigation</h2><p>In Go investing these kind of issues is easy as doing <code>go test . -cpuprofile=cpu.prof</code> and visualize it with <code>go tool pprof -http :8080 cpu.prof</code>. Which leads us to this:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/4c94_go_bigint_flame.png data-srcset="/4c94_go_bigint_flame.png, /4c94_go_bigint_flame.png 1.5x, /4c94_go_bigint_flame.png 2x" data-sizes=auto alt=/4c94_go_bigint_flame.png title="go big Int flame graph"></p><p>Easy to assume the interesting part is at &ldquo;nat&rdquo; an internal type of the &ldquo;math/big&rdquo; package. Let&rsquo;s check the big.nat.add() method:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/419c_nat_add_perf.png data-srcset="/419c_nat_add_perf.png, /419c_nat_add_perf.png 1.5x, /419c_nat_add_perf.png 2x" data-sizes=auto alt=/419c_nat_add_perf.png title="go big.nat.add() performance"></p><p><em>go math.big.nat Copyright 2009 The Go Authors. Check source and license <a href=https://cs.opensource.google/go/go/+/refs/tags/go1.18.2:src/math/big/nat.go target=_blank rel="noopener noreffer">link</a></em></p><p>Trying to reach conclusions from these metrics is a bit complicated since these metrics show the expected slow adding of two big numbers and also the &ldquo;unexpected&rdquo; slow performance of adding one to a big number. Still some ideas can be taken:</p><ul><li>The cumulative time taken on the line <code>c = addVW(z[n:m], x[n:], c)</code> is oddly close to the one second taken by adding one value.</li><li>The switch logic guarantees that the bigger number is always x when actually performing the addition. This means that z.Add(z, one) has the closely the same performance of z.Add(one, z).</li><li>The adding of numbers of different lengths is performed on two steps with <code>addVV()</code> and <code>addVW()</code>.</li><li>The bigger the different of lengths between x and y the more &ldquo;calculations&rdquo; can be expected from <code>addvw()</code>.</li></ul><h2 id=hypothesis-01-a-lengthier-bigint>Hypothesis 01, a lengthier big.Int</h2><p>If it is possible to define a big.Int with value 1 but a bigger length that would probably improve performance. Preferably having the same length has &ldquo;x&rdquo;, the bigger/lengthier summand, the addition could be performed in one go.</p><p>&ldquo;x&rdquo;,&ldquo;y&rdquo; are <code>big.nat</code>&rsquo;s which are slices of <code>Word</code>&rsquo;s so maybe I could create a <code>big.Int</code> with value one but having the bigger slice. This slice would have superfluous zeros to maintain the same value. Checking the <code>big.Int</code> public methods the following method seemed promising.</p><script src="https://emgithub.com/embed.js?target=https%3a%2f%2fgithub.com%2fgolang%2fgo%2fblob%2fmaster%2fsrc%2fmath%2fbig%2fint.go%23L89-L98&style=github&showBorder=on&showLineNumbers=on&showFileMeta=on"></script><p>Still, further checking the called method <code>nat.norm()</code> method this hypothesis gets destroyed.</p><script src="https://emgithub.com/embed.js?target=https%3a%2f%2fgithub.com%2fgolang%2fgo%2fblob%2f19156a54741d4f353c9e8e0860197ca95a6ee6ca%2fsrc%2fmath%2fbig%2fnat.go%23L49-L55&style=github&showBorder=on&showLineNumbers=on&showFileMeta=on"></script><p>The resulting slice is cut to remove all superfluous zeros. Checking the nat type description it&rsquo;s clear that is supposed to always happen.</p><h2 id=hypothesis-02-avoid-bigintadd>Hypothesis 02, avoid big.Int.Add()</h2><p>It seems that <code>big.Int.Add()</code> is following the overall architecture of <code>big.Int</code> and <code>big.nat</code>, supporting adding number of different sizes/lengths and expanding/contracting the results&rsquo; slices to remove superfluous zeros so the remaining option seems to be to just avoid using it.</p><p>Given that there&rsquo;s a <code>big.Int.SetBits()</code> and <code>big.Int.Bits()</code> there&rsquo;s probably a way to implement my own addition/increment. Furthermore, given how Go slices are implemented <code>big.Int.Bits()</code> is probably enough. Read <a href=https://go.dev/tour/moretypes/8 target=_blank rel="noopener noreffer">here</a> for more details about this.</p><p>Soooo <code>uint(big.NewInt(2).Bits()[0]) == uint(big.NewInt(1).Bits()[0])+1</code> actually works :)</p><h2 id=solution-and-benchmark>Solution and benchmark</h2><p>My increment/add one hack implementation:</p><script type=application/javascript src=https://gist.github.com/vpereira01/85572bf4c7c80765d76decde94384fb1.js></script><p>The performance graph, same tests, after the hack replaced <code>z.Add(z, one)</code>:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/6490_go_perf_graph_hack.png data-srcset="/6490_go_perf_graph_hack.png, /6490_go_perf_graph_hack.png 1.5x, /6490_go_perf_graph_hack.png 2x" data-sizes=auto alt=/6490_go_perf_graph_hack.png title="hack performance graph"></p><p><strong>big.Int.Add() was taking 6.71 seconds to now taking 5.11 seconds :)</strong></p><p>Notes:</p><ul><li>Overall almost 1.5 seconds was saved from using the <code>bigIntInc()</code>.</li><li>The <code>bigIntInc()</code> fallback to call <code>z.Add(z, one)</code> is almost never taken.</li><li>The <code>addVW()</code> method disappeared from the metrics since now only similar lengths numbers are being added.</li></ul><h2 id=extra-benchmarks>Extra benchmarks</h2><p>Since Go has a builtin benchmark tool I decided to try to benchmark this hack. Later I also found about <code>github.com/consensys/gnark-crypto/field</code> which is similar to <code>math/big</code> but optimized for speed so I also benchmarked against it.</p><pre tabindex=0><code>user@host$ go test . -run=nothing -bench=. -benchtime=5s
goos: linux
goarch: amd64
pkg: example.com/biigist
cpu: Intel(R) Core(TM) i5-4590T CPU @ 2.00GHz
BenchmarkBigIntInc/512bits_NewInt-4             94064070                57.74 ns/op
BenchmarkBigIntInc/512bits_NewInt_Add-4         64224325                92.77 ns/op
BenchmarkBigIntInc/512bits_NewInt_Inc-4         66054766                92.00 ns/op
BenchmarkBigIntInc/513bits_BIAdd-4              246136504               24.44 ns/op
BenchmarkBigIntInc/513bits_GFAdd-4              447096817               11.57 ns/op
BenchmarkBigIntInc/513bits_Inc-4                1000000000               3.913 ns/op
BenchmarkBigIntInc/1025bits_BIAdd-4             208855520               29.20 ns/op
BenchmarkBigIntInc/1025bits_GFAdd-4             514192068               11.43 ns/op
BenchmarkBigIntInc/1025bits_Inc-4               1000000000               3.905 ns/op
PASS
ok      example.com/biigist     57.451s
</code></pre><p>Explanation of the results:</p><ul><li><code>Inc</code> refers to my <code>bigIntInc()</code> method.</li><li><code>BIAdd</code> refers to <code>big.Int.Add()</code>.</li><li><code>GFAdd</code> refers to <code>gnark-crypto/field</code> Add.</li><li><code>512bits_</code> tests are the worse case for <code>bigIntInc()</code> since the fallback has to be taken. The bench run <code>512bits_NewInt</code> is to provide the baseline number of creating a new <code>big.Int</code> before each calculation which affects a lot the results.</li><li><code>513Bits_</code> refers to the amount of bits required to represent the base number used in the tests.</li></ul><p>You can check the benchmarks at <a href=https://github.com/vpereira01/biigist target=_blank rel="noopener noreffer">https://github.com/vpereira01/biigist</a></p><p><strong>In conclusion,</strong> if you need to increment a big.Int a lot of times for some reason implement a hack :)</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-05-13</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://vpereira01.com/posts/go-bigint-perf/ data-title="Go big.Int add one performance curiosity" data-hashtags=go,golang><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://vpereira01.com/posts/go-bigint-perf/ data-hashtag=go><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://vpereira01.com/posts/go-bigint-perf/ data-title="Go big.Int add one performance curiosity"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://vpereira01.com/posts/go-bigint-perf/ data-title="Go big.Int add one performance curiosity"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://vpereira01.com/posts/go-bigint-perf/ data-title="Go big.Int add one performance curiosity"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/go/>go</a>,&nbsp;<a href=/tags/golang/>golang</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/hey/ class=prev rel=prev title="Hi and site setup"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Hi and site setup</a>
<a href=/posts/zoom-ipv6-router-bug/ class=next rel=next title="Why is Zoom help page broken? A router IPv6 bug">Why is Zoom help page broken? A router IPv6 bug<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.110.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/about target=_blank>vpereira01</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>